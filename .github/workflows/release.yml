name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.os != 'macos-latest' }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        node-version: [20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Rebuild native modules
        run: npm run rebuild

      - name: Run type checking
        run: npm run typecheck

      - name: Set BUILD_NUMBER
        run: echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Build distributables
        run: npm run make
        env:
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Generate update manifests
        if: matrix.os == 'macos-latest'
        run: |
          # Generate latest-mac.yml for electron-updater
          mkdir -p out/make/update-manifests
          cat > out/make/update-manifests/latest-mac.yml << EOF
          version: $(node -p "require('./package.json').version")
          files:
            - url: SQLTemple-$(node -p "require('./package.json').version").dmg
              sha512: $(shasum -a 512 out/make/**/*.dmg | cut -d ' ' -f 1 | base64)
              size: $(stat -f%z out/make/**/*.dmg)
            - url: SQLTemple-$(node -p "require('./package.json').version")-darwin-x64.zip
              sha512: $(shasum -a 512 out/make/**/*.zip | cut -d ' ' -f 1 | base64)
              size: $(stat -f%z out/make/**/*.zip)
          path: SQLTemple-$(node -p "require('./package.json').version").dmg
          sha512: $(shasum -a 512 out/make/**/*.dmg | cut -d ' ' -f 1 | base64)
          releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
          EOF

      - name: Generate Windows update manifest
        if: matrix.os == 'windows-latest'
        run: |
          # Generate latest.yml for Windows electron-updater
          mkdir -p out/make/update-manifests
          $version = (Get-Content package.json | ConvertFrom-Json).version
          $exeFile = Get-ChildItem out/make -Recurse -Filter "*.exe" | Select-Object -First 1
          $hash = (Get-FileHash $exeFile.FullName -Algorithm SHA512).Hash
          $size = $exeFile.Length
          
          @"
          version: $version
          files:
            - url: SQLTemple-$version-Setup.exe
              sha512: $([Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($hash)))
              size: $size
          path: SQLTemple-$version-Setup.exe
          sha512: $([Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($hash)))
          releaseDate: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))
          "@ | Out-File -FilePath out/make/update-manifests/latest.yml -Encoding UTF8

      - name: Generate Linux update manifest
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Generate latest-linux.yml for electron-updater
          mkdir -p out/make/update-manifests
          VERSION=$(node -p "require('./package.json').version")
          DEB_FILE=$(find out/make -name "*.deb" | head -1)
          HASH=$(sha512sum "$DEB_FILE" | cut -d ' ' -f 1 | base64 -w 0)
          SIZE=$(stat -c%s "$DEB_FILE")
          
          cat > out/make/update-manifests/latest-linux.yml << EOF
          version: $VERSION
          files:
            - url: sqltemple_$VERSION_amd64.deb
              sha512: $HASH
              size: $SIZE
          path: sqltemple_$VERSION_amd64.deb
          sha512: $HASH
          releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
          EOF

      - name: List build outputs (macOS)
        if: matrix.os == 'macos-latest'
        run: ls -la out/make/

      - name: List build outputs (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: ls -la out/make/

      - name: List build outputs (Windows)
        if: matrix.os == 'windows-latest'
        run: dir out\make\

      - name: Upload macOS artifacts
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            out/make/**/*.dmg
            out/make/**/*.zip
            out/make/update-manifests/latest-mac.yml

      - name: Upload Linux artifacts
        if: matrix.os == 'ubuntu-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            out/make/**/*.deb
            out/make/**/*.rpm
            out/make/update-manifests/latest-linux.yml

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            out/make/**/*.exe
            out/make/**/*.msi
            out/make/update-manifests/latest.yml

  release:
    needs: build
    runs-on: ubuntu-latest
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          
          # Check if this is a tag push
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Tag push detected, will create release"
          else
            # For main branch, check if version changed in the last commit
            PREV_VERSION=$(git show HEAD~1:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null || echo "")
            echo "previous_version=${PREV_VERSION}" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
            
            if [ "$CURRENT_VERSION" != "$PREV_VERSION" ] && [ -n "$PREV_VERSION" ]; then
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "Version changed from ${PREV_VERSION} to ${CURRENT_VERSION}, will create release"
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "Version unchanged (${CURRENT_VERSION}), skipping release"
            fi
          fi

      - name: Extract version
        id: version
        if: steps.version_check.outputs.should_release == 'true'
        run: |
          echo "version=${{ steps.version_check.outputs.current_version }}" >> $GITHUB_OUTPUT
          echo "is_tag=${{ steps.version_check.outputs.is_tag }}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        if: steps.version_check.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        if: steps.version_check.outputs.should_release == 'true'
        run: ls -R artifacts

      - name: Create Release
        if: steps.version_check.outputs.should_release == 'true'
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version.outputs.is_tag == 'true' && github.ref_name || format('v{0}', steps.version.outputs.version) }}"
          RELEASE_NAME="SQLTemple ${{ steps.version.outputs.version }}"
          IS_PRERELEASE="${{ steps.version.outputs.is_tag == 'false' || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}"
          
          BODY="## SQLTemple ${{ steps.version.outputs.version }}

          ${{ steps.version.outputs.is_tag == 'false' && 'ðŸš§ **Development Build** - This is an automated build from the main branch.' || '' }}

          ### Downloads
          - **macOS**: Download the \`.dmg\` file
          - **Windows**: Download the \`.exe\` installer
          - **Linux**: Download the \`.deb\` (Ubuntu/Debian) or \`.rpm\` (RHEL/CentOS) package

          ### Changes
          See the [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref }}) for detailed changes."
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            gh release create "$TAG_NAME" --title "$RELEASE_NAME" --notes "$BODY" --prerelease
          else
            gh release create "$TAG_NAME" --title "$RELEASE_NAME" --notes "$BODY"
          fi

      - name: Upload Release Assets
        if: steps.version_check.outputs.should_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version.outputs.is_tag == 'true' && github.ref_name || format('v{0}', steps.version.outputs.version) }}"
          
          # Debug: Show all available files
          echo "Available files in artifacts:"
          find artifacts -type f -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.yml" | head -20
          
          # Upload macOS assets (required) - use glob patterns to find files
          DMG_FILE=$(find artifacts/macos-artifacts -name "*.dmg" | head -1)
          if [ -n "$DMG_FILE" ]; then
            echo "Uploading DMG: $DMG_FILE"
            gh release upload "$TAG_NAME" "$DMG_FILE" --clobber
          else
            echo "No DMG file found"
          fi
          
          ZIP_FILE=$(find artifacts/macos-artifacts -name "*.zip" | head -1)
          if [ -n "$ZIP_FILE" ]; then
            echo "Uploading ZIP: $ZIP_FILE"
            gh release upload "$TAG_NAME" "$ZIP_FILE" --clobber
          else
            echo "No ZIP file found"
          fi
          
          # Upload Windows assets (optional)
          EXE_FILE=$(find artifacts/windows-artifacts -name "*.exe" | head -1)
          if [ -n "$EXE_FILE" ]; then
            echo "Uploading EXE: $EXE_FILE"
            gh release upload "$TAG_NAME" "$EXE_FILE" --clobber || true
          fi
          
          # Upload Linux assets (optional)
          DEB_FILE=$(find artifacts/linux-artifacts -name "*.deb" | head -1)
          if [ -n "$DEB_FILE" ]; then
            echo "Uploading DEB: $DEB_FILE"
            gh release upload "$TAG_NAME" "$DEB_FILE" --clobber || true
          fi
          
          RPM_FILE=$(find artifacts/linux-artifacts -name "*.rpm" | head -1)
          if [ -n "$RPM_FILE" ]; then
            echo "Uploading RPM: $RPM_FILE"
            gh release upload "$TAG_NAME" "$RPM_FILE" --clobber || true
          fi
          
          # Upload update manifest files for electron-updater
          MAC_MANIFEST=$(find artifacts/macos-artifacts -name "latest-mac.yml" | head -1)
          if [ -n "$MAC_MANIFEST" ]; then
            echo "Uploading macOS update manifest: $MAC_MANIFEST"
            gh release upload "$TAG_NAME" "$MAC_MANIFEST" --clobber || true
          fi
          
          WIN_MANIFEST=$(find artifacts/windows-artifacts -name "latest.yml" | head -1)
          if [ -n "$WIN_MANIFEST" ]; then
            echo "Uploading Windows update manifest: $WIN_MANIFEST"
            gh release upload "$TAG_NAME" "$WIN_MANIFEST" --clobber || true
          fi
          
          LINUX_MANIFEST=$(find artifacts/linux-artifacts -name "latest-linux.yml" | head -1)
          if [ -n "$LINUX_MANIFEST" ]; then
            echo "Uploading Linux update manifest: $LINUX_MANIFEST"
            gh release upload "$TAG_NAME" "$LINUX_MANIFEST" --clobber || true
          fi